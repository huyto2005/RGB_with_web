<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 IoT Voice Master</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* CSS CHU·∫®N GI·ªÆ NGUY√äN */
        :root { --bg-color: #1e1e2e; --panel-color: #2b2b3b; --text-color: #ffffff; --accent-color: #00bcd4; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; user-select: none; overflow: hidden; }
        
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 1000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { background-color: var(--panel-color); padding: 40px; border-radius: 20px; width: 300px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.7); }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; background: #3a3a4a; border: 1px solid #555; border-radius: 8px; color: white; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 12px; background: var(--accent-color); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        #dashboard-screen { display: none; }
        .dashboard { background-color: var(--panel-color); padding: 30px; border-radius: 20px; width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; position: relative;}
        h2 { margin-top: 0; color: var(--accent-color); }
        .status { font-size: 12px; margin-bottom: 20px; color: #888; }
        .status.connected { color: #00ff88; }
        .status.disconnected { color: #ff4444; }

        /* VOICE BUTTON */
        .voice-container { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #444; }
        .voice-btn { width: 60px; height: 60px; border-radius: 50%; border: none; background: #333; color: #fff; font-size: 24px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: 0.3s; }
        .voice-btn:hover { background: var(--accent-color); transform: scale(1.1); }
        .voice-btn.listening { background: #ff4444; animation: pulse-voice 1.5s infinite; }
        @keyframes pulse-voice { 0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); } }
        #voice-text { display: block; margin-top: 10px; font-size: 14px; color: var(--accent-color); font-style: italic; height: 20px; }

        .power-container { display: flex; justify-content: space-between; align-items: center; background: #3a3a4a; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #00ff88; }
        input:checked + .slider:before { transform: translateX(24px); }
        
        #controls-area { transition: opacity 0.3s; }
        .disabled-ui { opacity: 0.3; pointer-events: none; }
        .slider-container { margin: 15px 0; }
        input[type=range] { width: 100%; cursor: pointer; }
        .label-text { font-size: 14px; margin-bottom: 5px; display: block; text-align: left; color: #ccc;}
        
        /* COLOR PICKER FULL */
        .current-color-section { background: #333; padding: 10px; border-radius: 12px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; }
        .color-picker-wrapper { width: 100px; height: 40px; border-radius: 8px; overflow: hidden; border: 2px solid #555; position: relative; }
        input[type="color"] { -webkit-appearance: none; appearance: none; border: none; padding: 0; margin: 0; background: none; cursor: pointer; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 150%; height: 150%; }
        
        .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .color-btn { width: 100%; height: 40px; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .color-btn.active { border: 2px solid white; transform: scale(1.1); }
        
        .effect-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; }
        .effect-btn { background: #444; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 12px; }
        .effect-btn:hover { background: var(--accent-color); }
        .effect-btn.active { background: var(--accent-color); font-weight: bold; box-shadow: 0 0 10px var(--accent-color); }

        .music-player-container { background: #333; padding: 15px; border-radius: 12px; margin-top: 20px; text-align: center; opacity: 0.5; pointer-events: none; transition: 0.3s; }
        .music-player-container.enabled { opacity: 1; pointer-events: all; }
        .custom-file-upload { border: 1px dashed var(--accent-color); display: block; padding: 10px; cursor: pointer; border-radius: 8px; color: var(--accent-color); margin-bottom: 10px; font-size: 13px; }
        input[type="file"] { display: none; }
        audio { width: 100%; height: 30px; margin-top: 5px; border-radius: 20px; }
        .music-active { border: 2px solid #ff4444 !important; box-shadow: 0 0 15px #ff4444; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="margin-bottom: 20px;">üîê ƒêƒÉng Nh·∫≠p IoT</h2>
            <input type="text" id="mqttUser" class="login-input" placeholder="HiveMQ Username">
            <input type="password" id="mqttPass" class="login-input" placeholder="HiveMQ Password">
            <button class="login-btn" onclick="startConnection()">K·∫æT N·ªêI</button>
            <p id="login-msg" style="color: red; font-size: 12px; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="dashboard-screen">
        <div class="dashboard">
            <h2><i class="fas fa-wifi"></i> IoT Controller</h2>
            <div id="connection-status" class="status disconnected">ƒêang x√°c th·ª±c...</div>
            <button onclick="location.reload()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: #666; cursor: pointer;"><i class="fas fa-sign-out-alt"></i></button>

            <div class="voice-container">
                <button id="btn-voice" class="voice-btn" onclick="toggleVoice()">
                    <i class="fas fa-microphone"></i>
                </button>
                <span id="voice-text">B·∫•m ƒë·ªÉ n√≥i...</span>
            </div>

            <div class="power-container">
                <span><strong>Ngu·ªìn T·ªïng</strong></span>
                <label class="switch">
                    <input type="checkbox" id="powerSwitch" onchange="togglePower()">
                    <span class="slider"></span>
                </label>
            </div>

            <div id="controls-area" class="disabled-ui">
                <div class="slider-container">
                    <span class="label-text">ƒê·ªô s√°ng: <span id="brightVal" style="color:var(--accent-color)">100</span>%</span>
                    <input type="range" min="0" max="100" value="100" id="brightnessRange" oninput="updateBrightness()">
                </div>
                <hr style="border-color: #444; opacity: 0.5; margin: 15px 0;">

                <span class="label-text">M√†u ƒëang hi·ªÉn th·ªã:</span>
                <div class="current-color-section">
                    <div class="color-picker-wrapper">
                        <input type="color" id="customColorPicker" value="#ff0000" oninput="handleColorWheel(this.value)">
                    </div>
                </div>

                <span class="label-text">M√†u c√≥ s·∫µn:</span>
                <div class="color-grid">
                    <button class="color-btn" id="btn-col-red" style="background: #ff0000" onclick="selectColor(255, 0, 0, this)"></button>
                    <button class="color-btn" id="btn-col-orange" style="background: #ff7f00" onclick="selectColor(255, 127, 0, this)"></button>
                    <button class="color-btn" id="btn-col-yellow" style="background: #ffff00" onclick="selectColor(255, 255, 0, this)"></button>
                    <button class="color-btn" id="btn-col-green" style="background: #00ff00" onclick="selectColor(0, 255, 0, this)"></button>
                    <button class="color-btn" id="btn-col-cyan" style="background: #00ffff" onclick="selectColor(0, 255, 255, this)"></button>
                    <button class="color-btn" id="btn-col-blue" style="background: #0000ff" onclick="selectColor(0, 0, 255, this)"></button>
                    <button class="color-btn" id="btn-col-purple" style="background: #8b00ff" onclick="selectColor(139, 0, 255, this)"></button>
                    <button class="color-btn" id="btn-col-white" style="background: #ffffff" onclick="selectColor(255, 255, 255, this)"></button>
                </div>

                <span class="label-text">Hi·ªáu ·ª©ng:</span>
                <div class="effect-grid">
                    <button class="effect-btn" id="btn-rainbow" onclick="selectEffect('rainbow')">Rainbow</button>
                    <button class="effect-btn" id="btn-chase" onclick="selectEffect('chase')">Chase</button>
                    <button class="effect-btn" id="btn-breath" onclick="selectEffect('breath')">Breath</button>
                    <button class="effect-btn" id="btn-music" onclick="selectEffect('music')">Music üéµ</button>
                </div>

                <div class="music-player-container" id="musicContainer">
                    <label class="custom-file-upload">
                        <input type="file" id="audioFile" accept="audio/*" onchange="handleFileUpload(this)">
                        <i class="fas fa-upload"></i> Ch·ªçn file nh·∫°c (MP3)
                    </label>
                    <span id="fileName" style="font-size: 11px; color: #888; display: block; margin-bottom: 5px;">Ch∆∞a ch·ªçn b√†i h√°t</span>
                    <audio id="audioPlayer" controls onplay="startMusicAnalysis()" onpause="pauseMusicAnalysis()"></audio>
                </div>
            </div>
        </div>
    </div>

    <script>
        const host = "53beae9b0e4b41f3b1b2dc76a5b641eb.s1.eu.hivemq.cloud"; 
        const port = 8884; 
        const topic = "esp32/led/control";
        
        let client = null;
        let audioContext, analyser, source, dataArray;
        let isAnalyzing = false;
        let lastBeatTime = 0;

        let state = { power: "OFF", mode: "static", brightness: 100, color: { r: 255, g: 0, b: 0 } };

        // --- GI·ªåNG N√ìI ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'vi-VN';
            recognition.continuous = false;
            
            recognition.onstart = function() {
                document.getElementById("btn-voice").classList.add("listening");
                document.getElementById("voice-text").innerText = "ƒêang nghe... üëÇ";
            };
            
            recognition.onend = function() {
                document.getElementById("btn-voice").classList.remove("listening");
                setTimeout(() => {
                    if(!document.getElementById("btn-voice").classList.contains("listening"))
                        document.getElementById("voice-text").innerText = "B·∫•m ƒë·ªÉ n√≥i...";
                }, 3000);
            };

            recognition.onresult = function(event) {
                const text = event.results[0][0].transcript.toLowerCase();
                document.getElementById("voice-text").innerText = 'ƒê√£ nghe: "' + text + '"';
                processVoiceCommand(text);
            };
        } else {
            document.getElementById("voice-text").innerText = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ üò¢";
        }

        function toggleVoice() {
            if (!recognition) return alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£!");
            recognition.start();
        }

        function processVoiceCommand(text) {
            // 1. L·ªánh Ngu·ªìn
            if (text.includes("b·∫≠t")) {
                document.getElementById("powerSwitch").checked = true;
                togglePower();
            } else if (text.includes("t·∫Øt") && !text.includes("nh·∫°c")) { // Tr√°nh nh·∫ßm v·ªõi "t·∫Øt nh·∫°c"
                document.getElementById("powerSwitch").checked = false;
                togglePower();
            }

            if (state.power === "OFF") return;

            // 2. L·ªánh ƒêi·ªÅu khi·ªÉn Nh·∫°c (M·ªöI)
            let audioPlayer = document.getElementById("audioPlayer");
            if (text.includes("d·ª´ng nh·∫°c") || text.includes("t·∫Øt nh·∫°c") || text.includes("ng∆∞ng")) {
                if(audioPlayer) audioPlayer.pause();
            } 
            else if (text.includes("ti·∫øp t·ª•c") || text.includes("ch∆°i nh·∫°c") || text.includes("ph√°t nh·∫°c")) {
                if(audioPlayer && state.mode === 'music') audioPlayer.play();
                else if (state.mode !== 'music') alert("H√£y chuy·ªÉn sang ch·∫ø ƒë·ªô Music tr∆∞·ªõc!");
            }

            // 3. L·ªánh Hi·ªáu ·ª©ng
            if (text.includes("ch·∫ø ƒë·ªô nh·∫°c") || text.includes("qu·∫©y")) selectEffect('music');
            else if (text.includes("c·∫ßu v·ªìng")) selectEffect('rainbow');
            else if (text.includes("ƒëu·ªïi") || text.includes("ch·∫°y")) selectEffect('chase');
            else if (text.includes("th·ªü") || text.includes("h√¥ h·∫•p")) selectEffect('breath');
            
            // 4. L·ªánh M√†u s·∫Øc (ƒê√£ map ƒë√∫ng ID n√∫t)
            else if (text.includes("ƒë·ªè")) selectColor(255, 0, 0, document.getElementById('btn-col-red'));
            else if (text.includes("cam")) selectColor(255, 127, 0, document.getElementById('btn-col-orange'));
            else if (text.includes("v√†ng")) selectColor(255, 255, 0, document.getElementById('btn-col-yellow'));
            else if (text.includes("xanh l√°") || text.includes("l·ª•c")) selectColor(0, 255, 0, document.getElementById('btn-col-green'));
            else if (text.includes("xanh l∆°") || text.includes("ng·ªçc") || text.includes("da tr·ªùi")) selectColor(0, 255, 255, document.getElementById('btn-col-cyan'));
            else if (text.includes("xanh d∆∞∆°ng") || text.includes("bi·ªÉn") || text.includes("lam")) selectColor(0, 0, 255, document.getElementById('btn-col-blue'));
            else if (text.includes("t√≠m")) selectColor(139, 0, 255, document.getElementById('btn-col-purple'));
            else if (text.includes("tr·∫Øng")) selectColor(255, 255, 255, document.getElementById('btn-col-white'));
        }

        // --- CORE FUNCTIONS ---
        function startConnection() {
            let u = document.getElementById("mqttUser").value;
            let p = document.getElementById("mqttPass").value;
            if(!u || !p) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin!");
            document.getElementById("login-msg").innerText = "ƒêang k·∫øt n·ªëi...";
            document.getElementById("login-msg").style.color = "yellow";
            const clientID = "web_" + Math.random().toString(16).substr(2, 8);
            client = new Paho.MQTT.Client(host, port, clientID);
            client.connect({ onSuccess: onConnect, onFailure: onFail, useSSL: true, userName: u, password: p });
        }

        function onConnect() {
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("dashboard-screen").style.display = "flex";
            document.getElementById("connection-status").innerText = "‚óè ƒê√£ k·∫øt n·ªëi HiveMQ Cloud";
            document.getElementById("connection-status").className = "status connected";
        }
        function onFail(e) { console.log(e); document.getElementById("login-msg").innerText = "L·ªói k·∫øt n·ªëi!"; }

        function sendCommand(extraData = {}) {
            if (!client || !client.isConnected()) return;
            let payload = JSON.stringify({ ...state, ...extraData });
            let message = new Paho.MQTT.Message(payload);
            message.destinationName = topic;
            client.send(message);
        }

        function togglePower() {
            state.power = document.getElementById("powerSwitch").checked ? "ON" : "OFF";
            let controls = document.getElementById("controls-area");
            if(state.power === "OFF") {
                controls.classList.add("disabled-ui");
                document.getElementById('audioPlayer').pause();
            } else {
                controls.classList.remove("disabled-ui");
            }
            sendCommand();
        }

        function updateBrightness() {
            state.brightness = parseInt(document.getElementById("brightnessRange").value);
            document.getElementById("brightVal").innerText = state.brightness;
            sendCommand();
        }

        function updateUIState() {
            document.querySelectorAll('.effect-btn').forEach(b => b.classList.remove('active'));
            let activeBtn = document.getElementById('btn-' + state.mode);
            if (activeBtn) activeBtn.classList.add('active');

            let musicContainer = document.getElementById("musicContainer");
            if (state.mode === 'music') {
                musicContainer.classList.add("enabled");
            } else {
                musicContainer.classList.remove("enabled");
                document.getElementById('audioPlayer').pause();
            }
        }

        function selectColor(r, g, b, btnElement) {
            state.color = { r: r, g: g, b: b };
            document.getElementById("customColorPicker").value = rgbToHex(r, g, b);
            
            if (state.mode === "rainbow") state.mode = "static";
            updateUIState();
            
            // X√≥a active c≈© v√† th√™m active m·ªõi
            if (btnElement) {
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                btnElement.classList.add('active');
            }
            sendCommand();
        }

        function handleColorWheel(hex) {
            let r = parseInt(hex.substring(1, 3), 16);
            let g = parseInt(hex.substring(3, 5), 16);
            let b = parseInt(hex.substring(5, 7), 16);
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            selectColor(r, g, b, null); 
        }

        function selectEffect(effectName) {
            state.mode = effectName;
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));

            if (effectName === 'chase') {
                state.color = { r: 255, g: 0, b: 0 }; 
                document.getElementById("customColorPicker").value = "#ff0000";
                document.getElementById('btn-col-red').classList.add('active'); // T·ª± b·∫•m n√∫t ƒê·ªè
            } else if (effectName === 'breath') {
                state.color = { r: 0, g: 0, b: 255 }; 
                document.getElementById("customColorPicker").value = "#0000ff";
                document.getElementById('btn-col-blue').classList.add('active'); // T·ª± b·∫•m n√∫t Xanh
            }
            updateUIState();
            sendCommand();
        }

        // --- MUSIC LOGIC ---
        function handleFileUpload(input) {
            let file = input.files[0];
            if (file) {
                let url = URL.createObjectURL(file);
                let player = document.getElementById("audioPlayer");
                player.src = url;
                document.getElementById("fileName").innerText = "üéµ " + file.name;
                if (!audioContext) initAudioContext();
            }
        }

        function initAudioContext() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            let player = document.getElementById("audioPlayer");
            source = audioContext.createMediaElementSource(player);
            analyser = audioContext.createAnalyser();
            source.connect(analyser);
            analyser.connect(audioContext.destination);
            analyser.fftSize = 256;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
        }

        function startMusicAnalysis() {
            if (!audioContext) initAudioContext();
            audioContext.resume();
            isAnalyzing = true;
            analyzeLoop();
        }

        function pauseMusicAnalysis() {
            isAnalyzing = false;
            document.getElementById("musicContainer").classList.remove("music-active");
        }

        function analyzeLoop() {
            if (!isAnalyzing) return;
            requestAnimationFrame(analyzeLoop);
            if (state.mode !== 'music') return;

            analyser.getByteFrequencyData(dataArray);
            let bassSum = 0;
            for (let i = 0; i < 10; i++) bassSum += dataArray[i];
            let bassAvg = bassSum / 10;

            if (bassAvg > 210) { 
                let now = Date.now();
                if (now - lastBeatTime > 100) { 
                    lastBeatTime = now;
                    sendCommand({ beat: true });
                    let container = document.getElementById("musicContainer");
                    container.classList.add("music-active");
                    setTimeout(() => container.classList.remove("music-active"), 100);
                }
            }
        }

        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
    </script>
</body>
</html>

